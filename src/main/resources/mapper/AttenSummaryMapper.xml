<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="zzjz.mapper.AttenSummaryMapper" >
  <resultMap id="BaseResultMap" type="zzjz.bean.AttenSummary" >
  <!--
    WARNING - @mbggenerated
    This element is automatically generated by MyBatis Generator, do not modify.
  -->
  <result column="user_id" property="userId" jdbcType="VARCHAR" />
  <result column="user_name" property="userName" jdbcType="VARCHAR" />
  <result column="depart" property="depart" jdbcType="VARCHAR" />
  <result column="workday" property="workday" jdbcType="DOUBLE" />
  <result column="actual" property="actual" jdbcType="DOUBLE" />
  <result column="late" property="late" jdbcType="DOUBLE" />
  <result column="early" property="early" jdbcType="DOUBLE" />
  <result column="absent" property="absent" jdbcType="DOUBLE" />
  <result column="overtime" property="overtime" jdbcType="DOUBLE" />
  <result column="deduction" property="deduction" jdbcType="DOUBLE" />
  <result column="meal" property="meal" jdbcType="DOUBLE" />
  <result column="off" property="off" jdbcType="DOUBLE" />
  <result column="annual" property="annual" jdbcType="DOUBLE" />
  <result column="compassionate" property="compassionate" jdbcType="DOUBLE" />
  <result column="marriage" property="marriage" jdbcType="DOUBLE" />
  <result column="sick" property="sick" jdbcType="DOUBLE" />
  <result column="funeral" property="funeral" jdbcType="DOUBLE" />
  <result column="maternity" property="maternity" jdbcType="DOUBLE" />
  <result column="trip" property="trip" jdbcType="DOUBLE" />
</resultMap>

  <select id="getSummaryList" resultMap="BaseResultMap" parameterType="java.lang.String">
     select a.*,b0.off,b1.annual,b2.compassionate,b3.marriage,b4.sick,b5.funeral,b6.maternity,c.trip from
          (select user_id,user_name,depart,sum(work_day) workday,sum(case when late>0 then 1 else 0 end) late,sum(case when early>0 then 1 else 0 end) early,sum(absent) absent,sum(over_time) overtime,
          sum(case late when 0.25 then 10 when 0.5 then 20 when 1.0 then 50 else '0' end) deduction,
          sum(case when absent>0 or all_day is not null or mor_day is not null or aft_day is not null then -15 else 0 end) meal
          from tb_attendance where SUBSTR(check_date,1,7)=#{month,jdbcType=VARCHAR}
          group by user_id,user_name,depart) a
          left join (select user_id,sum(leave_day) off from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='00' group by user_id) b0
          on (a.user_id=b0.user_id)
          left join (select user_id,sum(leave_day) annual from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='01' group by user_id) b1
          on (a.user_id=b1.user_id)
          left join (select user_id,sum(leave_day) compassionate from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='02' group by user_id) b2
          on (a.user_id=b2.user_id)
          left join (select user_id,sum(leave_day) marriage from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='03' group by user_id) b3
          on (a.user_id=b3.user_id)
          left join (select user_id,sum(leave_day) sick from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='04' group by user_id) b4
          on (a.user_id=b4.user_id)
          left join (select user_id,sum(leave_day) funeral from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='05' group by user_id) b5
          on (a.user_id=b5.user_id)
          left join (select user_id,sum(leave_day) maternity from tb_vacation where SUBSTR(leave_date,1,7)=#{month,jdbcType=VARCHAR} and leave_typ='06' group by user_id) b6
          on (a.user_id=b5.user_id)
          left join (select user_id,sum(trip_day) trip from tb_trip where SUBSTR(a_trip_date,1,7)=#{month,jdbcType=VARCHAR} group by user_id) c
          on (a.user_id=c.user_id)
  </select>
</mapper>